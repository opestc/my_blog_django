{% extends "base.html" %}
{% load bootstrap4 %}
{% load static %}
{% block title %}Chat Room{% endblock %}
{% block content %}

<div class="container" id="chating" style="font-family: BlinkMacSystemFont, sans-serif;">
	    <div class="row">
	    <div id="chat-users" class="col-2" style="margin: 0; padding: 5px; text-align: justify; overflow-x: hidden;">
		</div>
		<div class="col-10" style="position: relative; border: none;">

		<textarea id="chat-log" rows="20" class="col-12" style="padding: 5px; border: none; outline: none; background-color: transparent;"></textarea><br>
		<!--<button id="connections">Conn</button>-->
		<div class="col" style="position: absolute; bottom: 2px; align-self: center;">
		<input class="col-10" id="chat-message-input" type="text">
		<input id="chat-message-submit" type="button" value="Send" required>
		</div>
		</div>
		</div>
		{{ room_name|json_script:"room-name" }}
		{{ user_name|json_script:"user-name" }}
		<script>
			let ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
			
			const roomName = JSON.parse(document.getElementById('room-name').textContent);
			
			const chatSocket = new WebSocket(
				ws_scheme + '://'
				+ window.location.host
				+ '/ws/chat/'
				+ roomName
				+ '/'
			);
			let chatSocketh = new WebSocket(
				ws_scheme + '://'
				+ window.location.host
				+ '/ws/push/'
				+ roomName
			);
			
			$('#connections').click(function () {
				$.ajax({
					url: "{% url 'push' %}",
					type: "get",
					data: {
						"room": roomName,
						"user": "{{ user_name }}",
						"user_conn": true,
						"csrfmiddlewaretoken": "{{ csrf_token }}"
					},
					success: function (data) {

					}
				})
			})
			var d = new Date();
			chatSocket.onopen = function(e) {
				document.querySelector('#chat-log').value += ('[' + d.toDateString() +'] Welcome to chat group ' + roomName + '!\n');
			};
			
			// onmessage - An event listener to be called when a message is received from the server.
			chatSocket.onmessage = function(e) {
				// JSON.parse() converts the JSON object back into the original object,
				// then examine and act upon its contents.
				const data = JSON.parse(e.data);
				document.querySelector('#chat-log').value += (data.message + '\n');
				if (data.user_conn) {
					document.querySelector('#chat-users').innerHTML = '';
					for (x in data.users) {
						document.querySelector('#chat-users').innerHTML += "<i class='fas fa-user-circle'></i> " + data.users[x].bold() +'<br>';
					}
				}
			};
			
			chatSocketh.onmessage = function(e) {
				// JSON.parse() converts the JSON object back into the original object,
				// then examine and act upon its contents.
				let data = JSON.parse(e.data);
				document.querySelector('#chat-users').innerHTML = '';
				for (x in data.users) {
					document.querySelector('#chat-users').innerHTML += "<i class='fas fa-user-circle'></i> " + data.users[x].bold() +'<br>';
				}
			};
			
			// onclose - An event listener to be called when the connection is closed.
			chatSocket.onclose = function(e) {
				console.error('Chat socket closed unexpectedly');
			};
			
			chatSocketh.onclose = function(e) {
				console.error('Chat socket closed unexpectedly');
			};
			document.querySelector('#chat-message-input').focus();
			document.querySelector('#chat-message-input').onkeyup = function(e) {
				if (e.keyCode === 13) {  // enter, return
					document.querySelector('#chat-message-submit').click();
				}
			};
			
			document.querySelector('#chat-message-submit').onclick = function(e) {
				const messageInputDom = document.querySelector('#chat-message-input');
				const message = messageInputDom.value;
				
				// Send the msg object as a JSON-formatted string.
				chatSocket.send(JSON.stringify({
					'message': message
				}));
				
				// Blank the text input element, ready to receive the next line of text from the user.
				messageInputDom.value = '';
			};
		</script>
</div>
{% endblock content %}